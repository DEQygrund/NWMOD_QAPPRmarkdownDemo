---
author: "Demo 4: Branch"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
output:
  word_document:
    reference_docx: C:/Users/ygrund/ygrund_C_Users/PROJECTS/20210504_NWMOD/Demo/data/Report_Template.docx
    keep_md: yes
    toc: yes
    fig_caption: yes
    fig_width: 12
    fig_height: 6
  officedown::rdocx_document:
  html_document:
    toc: yes
    df_print: paged
---

---
title: "`r paste0("Modeling Quality Assurance Project Plan for the ", qapp_project_area, " Temperature Total Maximum Daily Load")`"
---

```{r, label=`setup`, include=FALSE}
options(knitr.duplicate.label = 'allow')
options(knitr.kable.NA = '')
options(tinytex.verbose = TRUE)

knitr::opts_chunk$set(results = "asis",
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      autodep = TRUE)

library(knitr); library(kableExtra)
library(officedown);library(officer)
library(tidyverse)
library(captioner)
library(readxl)
library(lubridate)
library(flextable)
library(sf); library(sp)
library(rgdal)
library(ggplot2)
library(stringr);library(stringi)
library(english)
library(pacman)
library(httr)

tbls  <- captioner::captioner(prefix="Table")
figs <- captioner::captioner(prefix="Figure")
eqns <- captioner::captioner(prefix="Equation")

```

\newpage

# Introduction

This Quality Assurance Project Plan (QAPP) summarizes the modeling approach to be used for the `r qapp_project_area` Temperature Total Maximum Daily Load (TMDL) replacement project.

A TMDL is a water quality restoration plan and the calculation of the maximum amount of a pollutant that a waterbody can receive while still meeting water quality standards for that particular pollutant. The maximum amount of loading a waterbody can receive is called the loading capacity. Loading from all pollutant sources must not exceed the loading capacity (TMDL) of a waterbody, including an appropriate margin of safety.

Load allocations are portions of the loading capacity that are attributed to either natural background sources or from non-point sources, such as urban, rural agriculture, or forestry activities. Wasteload allocations are portions of the total load that are allocated to point sources of pollution, such as wastewater treatment plants or industries. Wasteload allocations are used to establish effluent limits in NPDES discharge permits. Allocations may also be reserved for future uses, called reserve capacity. Allocations are quantified measures that assure water quality standard will be met and may distribute the pollutant loads between nonpoint and point sources. This general TMDL concept is represented by Equation 1.

$$TMDL = \sum WLA + \sum LA + \textit {Reserve Capacity} + MOS  \hspace{3em}\text{Equation 1}$$

Where $\sum {WLA}$ is the sum of wasteload allocations (point sources), $\sum {LA}$ is the sum of load allocations (nonpoint sources and background), Reserve Capacity is allocations reserved for future uses, and MOS is a margin-of-safety to account for uncertainty. For a temperature TMDL, these elements establish the maximum thermal loads that a waterbody may receive without exceeding applicable water quality standards for temperature designed to protect aquatic life and other beneficial uses.

The Clean Water Act requires TMDLs be developed for waterbodies that do not meet water quality standards and are listed as water quality impaired on the State’s 303(d) list. The `r qapp_project_area` includes several waterbodies listed on the Oregon 2018/2020 Section 303(d) Category 5 list as water quality limited for temperature.

In 2012, The U.S. District Court found that USEPA’s approval of an element of Oregon’s water quality standard for temperature, the Natural Conditions Criteria, was unlawful. The Natural Conditions Criterion stated that where the natural thermal potential of all or a portion of a waterbody exceeds the biologically-based numeric temperature criteria in OAR 340-041-0028(4), the natural thermal potential temperatures supersede the biologically-based criteria, and are deemed to be the applicable temperature criteria for that waterbody. This portion of the temperature water quality standard was effective from 2003 until USEPA disapproved it in response to the court decision in 2013. Many temperature TMDLs were based on this criteria, and this became the subject of a second lawsuit brought by the Northwest Environmental Advocates against USEPA asserting the USEPA unlawfully approved TMDLs that were based on the now disapproved Natural Conditions Criterion. The court issued a judgment on October 4, 2019, requiring DEQ and USEPA to replace 15 Oregon temperature TMDLs that were based on the Natural Conditions Criterion and to reissue the temperature TMDLs based on the remaining elements of the temperature water quality standard.

This QAPP has been developed to document the analysis and numerical modeling approach that will support the updated `r qapp_project_area` TMDL as well as other project details. This plan describes the proposed technical approach and quality assurance metrics to be evaluated in the updating of existing models to better represent current conditions in the subbasin. To that end, some of the modeling and analysis will form the basis of the modeling approach for the TMDL replacement. In particular, this QAPP details the following:

*	Definition of the issue and objectives, including the spatial and temporal extents of the water quality impairments (Section 2);    

*	A high-level description of the key processes and variables for temperature (Section 3);    

*	The overarching technical approach, including the appropriate modeling and analytical tools to be used (Section 4);    

*	The data sources for defining and creating inputs to the model, including data that were used in the modeling for the original TMDL. Examples of these inputs include weather, tributary stream flow and temperature, point sources and vegetation characteristics (Sections 5 and 6);    

*	How the analysis and modeling will be evaluated for acceptability (Sections 7 and 9);    

*	Scenarios for evaluating management strategies for reducing anthropogenic heat loads (Section 10);     

*	Various aspects for managing the TMDL development project, including documentation (Section 8), the project team (Section 11), data and records management (Sections 12  and 13); and    

*	Aspects relating to this QAPP and its role in the project (Sections 14  and 15).    

#	Problem Definition and Management 

```{r, include=FALSE}

lookup.huc <- readxl::read_xlsx("C:/Users/ygrund/ygrund_C_Users/PROJECTS/20210504_NWMOD/Demo/data/Lookup_QAPPProjectArea.xlsx", sheet = "Lookup_QAPPProjectArea")

cat.45.rivers <- sf::st_read(dsn = "C:/Users/ygrund/ygrund_C_Users/PROJECTS/20210504_NWMOD/Demo/data/2018_2020_IR_Cat4_5_Temp_Rivers_FINAL.shp",
                             layer = "2018_2020_IR_Cat4_5_Temp_Rivers_FINAL") %>% 
  sf::st_zm() %>% 
  dplyr::left_join(lookup.huc, by = "HUC12")

cat.45.tbl <- sf::st_drop_geometry(cat.45.rivers)

pro.cat.45.tbl <- cat.45.tbl %>% 
  dplyr::filter(QAPP_Project_Area %in% qapp_project_area)

tcat5 <- pro.cat.45.tbl %>% 
  dplyr::filter(IR_categor == "Category 5") %>% 
  dplyr::group_by(AU_Name,AU_ID,Year_liste) %>% 
  dplyr::summarize(Period = toString(unique(sort(Period)))) %>% 
  dplyr::ungroup() %>% 
  dplyr::rename(`Assessment Unit Name` = AU_Name,
                `Assessment Unit ID` = AU_ID,
                `Year Listed` = Year_liste,
                `Use Period` = Period) %>% 
  dplyr::select(`Assessment Unit Name`,`Assessment Unit ID`,`Year Listed`,`Use Period`) %>% 
  dplyr::arrange(`Assessment Unit Name`,`Year Listed`)

if(NROW(tcat5)>0){
  
  tcat5_tbl <- knitr::kable(tcat5, format = "pandoc", padding = 2,
                            caption = tbls(name = "tcat5",
                                           caption = paste0("Assessment units listed for temperature impairment in the ", qapp_project_area, " based on Section 303(d) Category 5 in the 2018/20 Integrated Report.")))
  
}

```

`r tcat5_tbl`

# Conceptual Model: Key Processes and Variables
# Technical Approach
## Overview
## Model Selection
## Software Development Quality Assessment
# Model Development
## Model Boundaries
## Spatial and Temporal Resolution
## Source Characteristics
## Data Availability and Quality
## Time Frame of Simulation
## Data Gaps
## Important Assumptions
## Model Calibration
## Model Parameters
# Model Evaluation and Acceptance
## Model Uncertainty and Sensitivity
## Model Acceptance
# Documentation in Model Reports
# Peer Review
# Management Scenarios
# Project Organization
## Project Team/Roles
## Expertise and Special Training Requirements
## Reports to Management
## Project Schedule
# Data Management
# Recordkeeping and Archiving
# QAPP Review and Approval
# Implementation and Adaptive Management
# References
